<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Vladikk : Developer, IBloggable]]></title>
  <link href="http://vladikk.github.io/atom.xml" rel="self"/>
  <link href="http://vladikk.github.io/"/>
  <updated>2013-05-14T14:27:12+03:00</updated>
  <id>http://vladikk.github.io/</id>
  <author>
    <name><![CDATA[Vladik Khononov]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Learning From Mistakes: Leaky Abstractions]]></title>
    <link href="http://vladikk.github.io/2012/10/15/learning-from-mistakes-leaky-abstractions/"/>
    <updated>2012-10-15T03:10:00+02:00</updated>
    <id>http://vladikk.github.io/2012/10/15/learning-from-mistakes-leaky-abstractions</id>
    <content type="html"><![CDATA[<p>On the project I’m working on I’ve had a requirement to store and read files
from the file system. Alse the files had to be accessible from the web.</p>

<p>Having a gut feeling that the infrastructure may change as the business will
grow, I decided to hide operations on the file system behind an interface:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='c#'><span class='line'><span class="k">public</span> <span class="k">interface</span> <span class="n">IFilesStorage</span> <span class="p">{</span>
</span><span class='line'>    <span class="kt">string</span> <span class="nf">StoreFile</span><span class="p">(</span><span class="n">Stream</span> <span class="n">stream</span><span class="p">,</span> <span class="kt">string</span> <span class="n">fileName</span><span class="p">);</span>
</span><span class='line'>    <span class="n">Stream</span> <span class="nf">GetFile</span><span class="p">(</span><span class="kt">string</span> <span class="n">virtualPath</span><span class="p">);</span>
</span><span class='line'>    <span class="kt">string</span> <span class="nf">GetFileUrl</span><span class="p">(</span><span class="kt">string</span> <span class="n">virtualPath</span><span class="p">);</span>
</span><span class='line'>    <span class="kt">string</span> <span class="nf">GetFilePath</span><span class="p">(</span><span class="kt">string</span> <span class="n">virtualPath</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>As it looks, if someday I’ll need to switch from the file
system to another storage mechanism, I’ll be able to do get the
job done by writing another implementation of the interface.
Right? Wrong! The requirement did come in - I’ve had to store
the files in S3. And only then I realised that IFilesStorage is
a leaky abstraction.</p>

<!-- more -->


<p>The problem lies in the last method, GetFilePath. This method
leaks out the implementation detail, that each file has a path
which can be used to access the file from the file system. Of
course, other storage mechanisms can’t provide such
functionality. This bummer makes switching storage mechanism
nearly impossible.</p>

<p>From a <a href="http://en.wikipedia.org/wiki/SOLID_%28object-oriented_design%29">SOLID</a> point of view, this issue can be seen as a
violation of the Liskov substitution principle: the file system
based implementation of the interface cannot be replaced by
another implementation, as it will break the correctness of the
application.</p>

<p>The solution was to drop the problematic method and get rid of
the dependancy on file paths in the system.</p>

<p>Lesson learned: having abstractions will make the code more testable,
but if you’re aiming for supple design, make
sure your abstractions don’t leak out details about the
underlying architecture.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Dependency Injection Patterns]]></title>
    <link href="http://vladikk.github.io/2012/09/10/dependency-injection-patterns/"/>
    <updated>2012-09-10T13:55:00+03:00</updated>
    <id>http://vladikk.github.io/2012/09/10/dependency-injection-patterns</id>
    <content type="html"><![CDATA[<p>Choosing the right pattern for implementing dependency injection is an important task and can affect your class’s usability and functionality. In this post I’ll overview 3 patterns of implementing dependency injection - constructor injection, property injection, builder (Joshua Bloch’s pattern, not GoF pattern).
For demonstration purposes we will work with a class called TextTranslator, that requires 3 dependencies: TextReader, TranslationService and TextWriter:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='c#'><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">TextTranslator</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">protected</span> <span class="n">TextReader</span> <span class="n">textReader</span><span class="p">;</span>
</span><span class='line'>    <span class="k">protected</span> <span class="n">TranslationService</span> <span class="n">translationService</span><span class="p">;</span>
</span><span class='line'>    <span class="k">protected</span> <span class="n">TextWriter</span> <span class="n">textWriter</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The sample code will be written in C#, but the examples are applicable to Java and other object oriented languages.</p>

<!-- more -->


<h2>Constructor Injection</h2>

<p>The implementation of this pattern is simple - expose a constructor that accepts its dependencies as arguments. This pattern works best for required dependencies - when the user of your class shouldn&#8217;t be able to instantiate an object without passing the dependencies:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='c#'><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">TextTranslator</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">protected</span> <span class="k">readonly</span> <span class="n">TextReader</span> <span class="n">textReader</span><span class="p">;</span>
</span><span class='line'>    <span class="k">protected</span> <span class="k">readonly</span> <span class="n">TranslationService</span> <span class="n">translationService</span><span class="p">;</span>
</span><span class='line'>    <span class="k">protected</span> <span class="k">readonly</span> <span class="n">TextWriter</span> <span class="n">textWriter</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="nf">TextTranslator</span><span class="p">(</span><span class="n">TextReader</span> <span class="n">textReader</span><span class="p">,</span>
</span><span class='line'>                          <span class="n">TranslationSerivce</span> <span class="n">translationService</span><span class="p">,</span>
</span><span class='line'>                          <span class="n">TextWriter</span> <span class="n">textWriter</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">this</span><span class="p">.</span><span class="n">textReader</span> <span class="p">=</span> <span class="n">textReader</span><span class="p">;</span>
</span><span class='line'>        <span class="k">this</span><span class="p">.</span><span class="n">translationService</span> <span class="p">=</span> <span class="n">translationService</span><span class="p">;</span>
</span><span class='line'>        <span class="k">this</span><span class="p">.</span><span class="n">textWriter</span> <span class="p">=</span> <span class="n">textWriter</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Usage:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='c#'><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">Program</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">Main</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">// create the dependencies</span>
</span><span class='line'>        <span class="kt">var</span> <span class="n">textReader</span> <span class="p">=</span> <span class="k">new</span> <span class="n">TextReader</span><span class="p">();</span>
</span><span class='line'>        <span class="kt">var</span> <span class="n">translationService</span> <span class="p">=</span> <span class="k">new</span> <span class="n">TranslationService</span><span class="p">();</span>
</span><span class='line'>        <span class="kt">var</span> <span class="n">textWriter</span> <span class="p">=</span> <span class="k">new</span> <span class="n">TextWriter</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// instantiate the TextTranslator class and pass its dependencies</span>
</span><span class='line'>        <span class="kt">var</span> <span class="n">translator</span> <span class="p">=</span> <span class="k">new</span> <span class="n">TextTranslator</span><span class="p">(</span><span class="n">textReader</span><span class="p">,</span>
</span><span class='line'>                                            <span class="n">translationService</span><span class="p">,</span> <span class="n">textWriter</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Pros</h3>

<ul>
<li>This pattern is the best choice for required dependencies. It communicates clearly what instances should be provided. Also, this is the only choice if the injected dependency is to be stored in a readonly field.</li>
<li>Simple implementation.</li>
<li>Integrates easily with dependency injection containers - you are not required to add any special attributes in order for a container to supply the dependencies.</li>
</ul>


<h3>Cons</h3>

<ul>
<li>This pattern causes the number of constructor parameters to grow. It&#8217;s considered a bad practice for a constructor to have more than 3-4 arguments. When this happens, it&#8217;s time to step back and consider some refactorings. First, being dependant on many objects may be a clear sign of breaking the single responsibility principle. If this is the case, split the functionality between multiple classes. Otherwise, use the Introduce Parameter Object refactoring.</li>
</ul>


<h2>Property Injection (Setter Injection)</h2>

<p>The class that needs a dependency exposes a property with public setter that is used for injection of the dependency. Since the dependencies are passed after the object is instantiated, this pattern works best for optional dependencies - when default instances of the dependencies are created in a constructor, and the user should be able to inject an alternative implementation:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='c#'><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">TextTranslator</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">public</span> <span class="n">TextReader</span> <span class="n">TextReader</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>    <span class="k">public</span> <span class="n">TranslationService</span> <span class="n">TranslationService</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>    <span class="k">public</span> <span class="n">TextWriter</span> <span class="n">TextWriter</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="nf">TextTranslator</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">this</span><span class="p">.</span><span class="n">TextReader</span> <span class="p">=</span> <span class="k">new</span> <span class="n">DefaultTextReader</span><span class="p">();</span>
</span><span class='line'>        <span class="k">this</span><span class="p">.</span><span class="n">TranslationService</span> <span class="p">=</span> <span class="k">new</span> <span class="n">DefaultTranslationService</span><span class="p">();</span>
</span><span class='line'>        <span class="k">this</span><span class="p">.</span><span class="n">TextWriter</span> <span class="p">=</span> <span class="k">new</span> <span class="n">DefaultTextWriter</span><span class="p">();</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Usage:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='c#'><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">Program</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">Main</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">// instantiate the TextTranslator class</span>
</span><span class='line'>        <span class="kt">var</span> <span class="n">translator</span> <span class="p">=</span> <span class="k">new</span> <span class="n">TextTranslator</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// create and pass the dependencies</span>
</span><span class='line'>        <span class="n">translator</span><span class="p">.</span><span class="n">TextReader</span> <span class="p">=</span> <span class="k">new</span> <span class="n">CustomTextReader</span><span class="p">();</span>
</span><span class='line'>        <span class="n">translator</span><span class="p">.</span><span class="n">TranslationService</span> <span class="p">=</span> <span class="k">new</span> <span class="n">CustomTranslationService</span><span class="p">();</span>
</span><span class='line'>        <span class="n">translator</span><span class="p">.</span><span class="n">TextWriter</span> <span class="p">=</span> <span class="k">new</span> <span class="n">CustomTextWriter</span><span class="p">();</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Pros</h3>

<ul>
<li>The best choice for optional dependencies.</li>
<li>Simple implementation.</li>
<li>Integrates with dependency injection containers (the properties that hold dependencies should be marked with a special attribute, e.g. “[Dependency]”).</li>
</ul>


<h3>Cons</h3>

<ul>
<li>Not suitable  for required dependencies. It doesn’t communicate well what dependencies should be supplied, and allows the user not to supply them.</li>
<li>The dependency is mutable. Users can inject different implementations of the same dependency during the object’s lifetime.</li>
</ul>


<h2>Builder (Joshua Bloch’s pattern)</h2>

<p>This pattern gives you the best of two worlds - it allows you to limit the constructor parameters to the required dependencies, yet it still allows setting optional dependencies during the instantiation phase.
To implement this pattern you have to expose a public constructor that takes instances of the required dependencies as arguments and define private/protected fields to hold the optional dependencies. The optional dependencies can be set by using an instance of inner Builder class. Because Builder is an inner class, it can access and modify parent class’s protected and private fields.
Let’s see how this pattern can be implemented. In this example TranslationService is a required dependency, but TextReader and TextWriter are optional:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
</pre></td><td class='code'><pre><code class='c#'><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">TextTranslator</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">private</span> <span class="n">TextReader</span> <span class="n">textReader</span><span class="p">;</span>
</span><span class='line'>    <span class="k">private</span> <span class="n">TranslationService</span> <span class="n">translationService</span><span class="p">;</span>
</span><span class='line'>    <span class="k">private</span> <span class="n">TextWriter</span> <span class="n">textWriter</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="nf">TextTranslator</span><span class="p">(</span><span class="n">TranslationService</span> <span class="n">translationService</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">// set the required dependency</span>
</span><span class='line'>        <span class="k">this</span><span class="p">.</span><span class="n">translationService</span> <span class="p">=</span> <span class="n">translationService</span><span class="p">;</span>
</span><span class='line'>        <span class="c1">// set default values for the optional dependencies</span>
</span><span class='line'>        <span class="k">this</span><span class="p">.</span><span class="n">textReader</span> <span class="p">=</span> <span class="k">new</span> <span class="n">DefaultTextReader</span><span class="p">();</span>
</span><span class='line'>        <span class="k">this</span><span class="p">.</span><span class="n">textWriter</span> <span class="p">=</span> <span class="k">new</span> <span class="n">DefaultTextWriter</span><span class="p">();</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="k">class</span> <span class="nc">Builder</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="k">private</span> <span class="n">TextReader</span> <span class="n">textReader</span><span class="p">;</span>
</span><span class='line'>        <span class="k">private</span> <span class="n">TranslationService</span> <span class="n">translationService</span><span class="p">;</span>
</span><span class='line'>        <span class="k">private</span> <span class="n">TextWriter</span> <span class="n">textWriter</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">public</span> <span class="nf">Builder</span><span class="p">(</span><span class="n">TranslationService</span> <span class="n">translationService</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">this</span><span class="p">.</span><span class="n">translationService</span> <span class="p">=</span> <span class="n">translationService</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">public</span> <span class="n">Builder</span> <span class="nf">WtihTextReader</span><span class="p">(</span><span class="n">TextReader</span> <span class="n">textReader</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">this</span><span class="p">.</span><span class="n">textReader</span> <span class="p">=</span> <span class="n">textReader</span><span class="p">;</span>
</span><span class='line'>            <span class="k">return</span> <span class="k">this</span><span class="p">.</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">public</span> <span class="n">Builder</span> <span class="nf">WithTextWriter</span><span class="p">(</span><span class="n">TextWriter</span> <span class="n">textWriter</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">this</span><span class="p">.</span><span class="n">textWriter</span> <span class="p">=</span> <span class="n">textWriter</span><span class="p">;</span>
</span><span class='line'>            <span class="k">return</span> <span class="k">this</span><span class="p">.</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">public</span> <span class="n">TextTranslator</span> <span class="nf">Build</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>            <span class="kt">var</span> <span class="n">result</span> <span class="p">=</span> <span class="k">new</span> <span class="n">TextTranslator</span><span class="p">(</span><span class="n">translationService</span><span class="p">);</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="n">textReader</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">result</span><span class="p">.</span><span class="n">textReader</span> <span class="p">=</span> <span class="n">textReader</span><span class="p">;</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="n">textWriter</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">result</span><span class="p">.</span><span class="n">textWriter</span> <span class="p">=</span> <span class="n">textWriter</span><span class="p">;</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>            <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Usage:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='c#'><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">Program</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">Main</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">// create the dependencies</span>
</span><span class='line'>        <span class="kt">var</span> <span class="n">textReader</span> <span class="p">=</span> <span class="k">new</span> <span class="n">TextReader</span><span class="p">();</span>
</span><span class='line'>        <span class="kt">var</span> <span class="n">translationService</span> <span class="p">=</span> <span class="k">new</span> <span class="n">TranslationService</span><span class="p">();</span>
</span><span class='line'>        <span class="kt">var</span> <span class="n">textWriter</span> <span class="p">=</span> <span class="k">new</span> <span class="n">TextWriter</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// instantiate the TextTranslator class using its Builder</span>
</span><span class='line'>        <span class="kt">var</span> <span class="n">translator</span> <span class="p">=</span> <span class="k">new</span> <span class="n">TextTranslator</span><span class="p">.</span><span class="n">Builder</span><span class="p">(</span><span class="n">translationService</span><span class="p">)</span>
</span><span class='line'>                            <span class="p">.</span><span class="n">WithTextReader</span><span class="p">(</span><span class="n">textReader</span><span class="p">)</span>
</span><span class='line'>                            <span class="p">.</span><span class="n">WithTextWriter</span><span class="p">(</span><span class="n">textWriter</span><span class="p">)</span>
</span><span class='line'>                            <span class="p">.</span><span class="n">Build</span><span class="p">();</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>As you can see, Builder’s constructor mirrors its parent’s constructor - it accepts the same required dependencies. The optional dependencies are set via fluent interface that follows the “.WithFieldName(fieldValue)” convention. When all the values are passed, the Build method is called, which constructs a new instance and passes the available optional dependencies.</p>

<h3>Pros</h3>

<ul>
<li>Minimises the number of constructor arguments to the number of the required dependencies.</li>
<li>All the dependencies are immutable for the user.</li>
<li>Doesn’t require exposal of public setters for optional dependencies.</li>
<li>Dependency injection containers can supply required dependencies</li>
</ul>


<h3>Cons</h3>

<ul>
<li>Extra code you have to write to implement this pattern.</li>
<li>Dependency injection containers cannot supply optional dependencies.</li>
</ul>


<h2>Conclusion</h2>

<p>Use Constructor Injection for required dependencies. For optional dependencies, if you can allow mutable dependencies, use Property Injection, otherwise implement the Builder pattern.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Disposing Objects Created by DI Container]]></title>
    <link href="http://vladikk.github.io/2012/08/23/disposing-objects-created-by-di-container/"/>
    <updated>2012-08-23T07:57:00+03:00</updated>
    <id>http://vladikk.github.io/2012/08/23/disposing-objects-created-by-di-container</id>
    <content type="html"><![CDATA[<p>The general rule says that if you created an object, then it is your responsibility to dispose it. Things get a bit tricky when objects are created by a dependency injection container. The responsibility of containers is to construct objects and inject the dependencies they need. An error I’ve seen people doing again and again is to dispose objects that were injected into an object via constructor or property injection. Consider the class “Foo” that requires an instance of class “Bar”:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='c#'><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">Foo</span> <span class="p">:</span> <span class="n">IDisposable</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">protected</span> <span class="n">Bar</span> <span class="n">bar</span><span class="p">;</span>
</span><span class='line'>    <span class="k">public</span> <span class="nf">Foo</span><span class="p">(</span><span class="n">Bar</span> <span class="n">bar</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">this</span><span class="p">.</span><span class="n">bar</span> <span class="p">=</span> <span class="n">bar</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">void</span> <span class="nf">Dispose</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">bar</span><span class="p">.</span><span class="n">Dispose</span><span class="p">();</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">Program</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">static</span> <span class="k">void</span> <span class="nf">Main</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="kt">var</span> <span class="n">foo</span> <span class="p">=</span> <span class="n">container</span><span class="p">.</span><span class="n">Resolve</span><span class="p">&lt;</span><span class="n">Foo</span><span class="p">&gt;();</span>
</span><span class='line'>        <span class="p">...</span>
</span><span class='line'>        <span class="n">foo</span><span class="p">.</span><span class="n">Dispose</span><span class="p">();</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The problem with this approach is that the “Foo” class will know too much about the environment it runs in. At least it will think it does. An instance of “Foo” can’t and shouldn’t know who passed in the instance of “Bar”, and what he intends to do with it after the instance of “Foo” will be disposed.</p>

<!-- more -->


<p>So who should dispose “Bar”? As I said in the beginning of the post, if you created an instance, then you should dispose it. In our case, a dependency injection container has created an object and its dependencies, and therefore it should be responsible for disposing them. Usually containers will have a special method for disposing objects, for example “TearDown” in Unity and “Release” in Windsor.
Let’s see what the correct disposal strategy will look like in our Foo &amp; Bar case:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='c#'><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">Foo</span> <span class="p">:</span> <span class="n">IDisposable</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">protected</span> <span class="n">Bar</span> <span class="n">bar</span><span class="p">;</span>
</span><span class='line'>    <span class="k">public</span> <span class="nf">Foo</span><span class="p">(</span><span class="n">Bar</span> <span class="n">bar</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">this</span><span class="p">.</span><span class="n">bar</span> <span class="p">=</span> <span class="n">bar</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">void</span> <span class="nf">Dispose</span><span class="p">()</span> <span class="p">{</span> <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">Program</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">static</span> <span class="k">void</span> <span class="nf">Main</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="kt">var</span> <span class="n">foo</span> <span class="p">=</span> <span class="n">container</span><span class="p">.</span><span class="n">Resolve</span><span class="p">&lt;</span><span class="n">Foo</span><span class="p">&gt;();</span>
</span><span class='line'>        <span class="p">...</span>
</span><span class='line'>        <span class="n">container</span><span class="p">.</span><span class="n">TearDown</span><span class="p">(</span><span class="n">foo</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Note: Microsoft being Microsoft, didn’t implement the TearDown method correctly in their Unity framework. Out of the box, the method only disposes the passed object, and ignores the dependencies it created to construct it. The best solution to this issue is to use Rory Primrose’s <a href="http://www.neovolve.com/post/2010/06/18/Unity-Extension-For-Disposing-Build-Trees-On-TearDown.aspx">plugin that implements the absent functionality</a>.</p>
]]></content>
  </entry>
  
</feed>
